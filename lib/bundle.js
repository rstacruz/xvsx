var marked = require('marked');
var files = process.argv.slice(2);

var re = work(files);
console.log(JSON.stringify(re, null, 2));

function work (files) {
  var re = {
    "": [
      "---",
      "--- This file is autogenerated.",
      "--- Please don't edit this file.",
      "---",
    ],
    languages: {}
  };

  // step 1: build each
  files.forEach(function (file) {
    var data = require('fs').readFileSync(file, 'utf-8');
    var name = require('path').basename(file, '.md');

    re.languages[name] = eat(data);
  });

  // step 2: build outline
  var outline = {};
  Object.keys(re.languages).forEach(function (lang) {
    var sections = re.languages[lang];
    Object.keys(sections).forEach(function (h2) {
      var subsections = sections[h2];
      outline[h2] = {};
      Object.keys(subsections).forEach(function (h3) {
        outline[h2][h3] = {};
      });
    });
  });
  re.outline = outline;

  return re;
}

function eat (md) {
  var tokens = marked.lexer(md);
  var re = {};
  var h2, h3;

  tokens.forEach(function (t) {
    // token.type == 'heading' | 'paragraph' | 'code' | 'list_start' | 'list_item_start' | 'list_item_end'
    // token.text == '...' (paragraph, heading)
    // token.lang == 'rb' (code)
    // token.depth == 1 | 2 | 3
    //
    if (t.type === 'heading' && t.depth === 1) {
    }
    else if (t.type === 'heading' && t.depth === 2) {
      re[t.text] = {};
      h2 = re[t.text];
    } 
    else if (t.type === 'heading' && t.depth === 3) {
      h2[t.text] = { text: null, code: null };
      h3 = h2[t.text];
    }
    else if (t.type === 'code') {
      h3.code = t.text;
    }
    else if (t.type === 'paragraph') {
      if (h3.text) {
        h3.text += '\n\n' + t.text;
      } else {
        h3.text = t.text;
      }
    }
  });

  return re;
}
