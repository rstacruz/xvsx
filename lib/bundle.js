var marked = require('marked');

/*
 * Work
 */

if (module.parent) {
  var files = process.argv.slice(2);
  var re = work(files);
  console.log(JSON.stringify(re, null, 2));
}

/**
 * Works on given `files`, an array of files.
 * Returns a JSON that looks:
 *
 *     {
 *       languages: {
 *         _outline: { ... },
 *         javascript: { ... },
 *         ruby: { ... }
 *       }
 *    }
 */

function work (files) {
  var re = {
    "": [
      "---",
      "--- This file is autogenerated.",
      "--- Please don't edit this file.",
      "---",
    ],
    languages: {}
  };

  // step 1: build each
  files.forEach(function (file) {
    var data = require('fs').readFileSync(file, 'utf-8');
    var name = require('path').basename(file, '.md');

    re.languages[name] = eat(data);
  });

  return re;
}

/**
 * Eats a markdown document.
 * Returns a JSON object of the language.
 *
 *     eat("### Variables\n\n    var x = 1;");
 */

function eat (md) {
  var tokens = marked.lexer(md);
  var re = {};
  var h2, h3;

  tokens.forEach(function (t) {
    // token.type == 'heading' | 'paragraph' | 'code' | 'list_start' | 'list_item_start' | 'list_item_end'
    // token.text == '...' (paragraph, heading)
    // token.lang == 'rb' (code)
    // token.depth == 1 | 2 | 3
    //
    if (t.type === 'heading' && t.depth === 1) {
    }
    else if (t.type === 'heading' && t.depth === 2) {
      re[t.text] = {};
      h2 = re[t.text];
    } 
    else if (t.type === 'heading' && t.depth === 3) {
      h2[t.text] = {};
      h3 = h2[t.text];
    }
    else if (t.type === 'code') {
      h3.code = t.text;
    }
    else if (t.type === 'paragraph') {
      if (h3) {
        if (h3.text) {
          h3.text += '\n\n' + t.text;
        } else {
          h3.text = t.text;
        }
      }
    }
  });

  return re;
}
